<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ateliê Epistolar</title>
    
    <!-- Tailwind CSS para um design rápido e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tone.js para gerar os sons da máquina de escrever dinamicamente -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- NOVA BIBLIOTECA: html2pdf.js para gerar o PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Fonte para a interface e para a máquina de escrever -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Special+Elite&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .font-typewriter {
            font-family: 'Special Elite', monospace;
        }

        #hidden-textarea {
            position: absolute;
            left: -9999px;
            top: 0;
            opacity: 0;
        }

        #paper {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease-in-out;
            cursor: text;
        }

        .paper-linho-marfim {
            background-color: #FDFBF5;
            border: 1px solid #EAE6DA;
        }

        .paper-pergaminho-salinas {
            background-color: #F5EEDC;
            background-image: 
                linear-gradient(rgba(210, 180, 140, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(210, 180, 140, 0.15) 1px, transparent 1px);
            background-size: 20px 20px;
            border: 1px solid #D2B48C;
            box-shadow: 0 10px 30px rgba(80, 50, 20, 0.2);
        }
        
        .paper-rascunho-poeta {
            background-color: #FFFFFF;
            background-image:
                repeating-linear-gradient(to bottom, 
                    transparent, 
                    transparent 24px, 
                    #E2E8F0 24px, 
                    #E2E8F0 25px);
            border-left: 3px solid #F87171;
        }
        
        #cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: #333;
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
        }

        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #333; }
        }

        .control-button {
            transition: all 0.2s ease;
        }
        .control-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .control-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- TELA 1: SELEÇÃO DE PAPEL -->
    <div id="paper-selection-screen" class="w-full max-w-4xl text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 font-typewriter">Ateliê Epistolar</h1>
        
        <div class="text-lg text-gray-600 mb-10 mx-auto max-w-2xl space-y-4">
            <p>Num tempo de palavras apressadas, que nascem e morrem no mesmo instante, este é um refúgio.</p>
            <p>Um lugar para a pausa. Para sentir o peso de cada letra, o som de cada ideia a tomar forma. Um ato de resistência contra o efémero.</p>
            <p class="font-semibold">Escolha o seu papel. Dê tempo ao seu pensamento. Escreva para que permaneça.</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Opções de papel... -->
            <div class="paper-option bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer" data-paper-type="paper-linho-marfim">
                <div class="w-full h-32 paper-linho-marfim rounded mb-4 border"></div>
                <h2 class="text-xl font-bold mb-2">Papel Linho Marfim</h2>
                <p class="text-gray-600">Um clássico atemporal. Ideal para uma correspondência elegante ou uma reflexão profunda.</p>
            </div>
            <div class="paper-option bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer" data-paper-type="paper-pergaminho-salinas">
                <div class="w-full h-32 paper-pergaminho-salinas rounded mb-4 border"></div>
                <h2 class="text-xl font-bold mb-2">Pergaminho "Salinas, 1920"</h2>
                <p class="text-gray-600">Um papel envelhecido, para cartas que dialogam com a própria História e a memória.</p>
            </div>
            <div class="paper-option bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer" data-paper-type="paper-rascunho-poeta">
                <div class="w-full h-32 paper-rascunho-poeta rounded mb-4 border"></div>
                <h2 class="text-xl font-bold mb-2">Rascunho do Poeta</h2>
                <p class="text-gray-600">Para o pensamento em ebulição, crônicas do cotidiano e a urgência da inspiração.</p>
            </div>
        </div>
    </div>

    <!-- TELA 2: ESCRITA DA CARTA -->
    <div id="writing-screen" class="hidden w-full h-full flex flex-col items-center">
        <textarea id="hidden-textarea" autofocus></textarea>
        
        <div id="paper" class="w-full max-w-3xl h-[80vh] p-8 md:p-12 overflow-y-auto font-typewriter text-2xl leading-loose">
            <span id="paper-content"></span><span id="cursor"></span>
        </div>
        
        <!-- Controles atualizados -->
        <div id="controls" class="mt-6 flex flex-wrap gap-4 justify-center">
            <button id="btn-email" class="control-button bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar por Email</button>
            <!-- BOTÃO ALTERADO -->
            <button id="btn-pdf" class="control-button bg-green-600 text-white font-bold py-2 px-5 rounded-lg">Baixar em PDF</button>
            <button id="btn-back" class="control-button bg-gray-500 text-white font-bold py-2 px-5 rounded-lg">Trocar Papel</button>
        </div>
    </div>

    <script>
        // --- Elementos do DOM ---
        const paperSelectionScreen = document.getElementById('paper-selection-screen');
        const writingScreen = document.getElementById('writing-screen');
        const paperOptions = document.querySelectorAll('.paper-option');
        const paper = document.getElementById('paper');
        const paperContent = document.getElementById('paper-content');
        const hiddenTextarea = document.getElementById('hidden-textarea');
        const btnEmail = document.getElementById('btn-email');
        const btnPdf = document.getElementById('btn-pdf'); // Novo botão
        const btnBack = document.getElementById('btn-back');
        const cursor = document.getElementById('cursor');

        let currentText = '';

        // --- Configuração dos Sons com Tone.js ---
        const keyClickSound = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 6, oscillator: { type: 'square' }, envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.2, }}).toDestination();
        keyClickSound.volume.value = -10;
        const plingSound = new Tone.MetalSynth({ frequency: 400, envelope: { attack: 0.001, decay: 0.4, release: 0.2 }, harmonicity: 8.1, modulationIndex: 40, resonance: 3000, octaves: 1.5 }).toDestination();
        plingSound.volume.value = -8;
        const carriageReturnSound = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 }}).toDestination();
        carriageReturnSound.volume.value = -15;

        // --- Lógica da Aplicação ---

        // 1. Seleção do Papel
        paperOptions.forEach(option => {
            option.addEventListener('click', () => {
                const paperType = option.getAttribute('data-paper-type');
                paper.className = `w-full max-w-3xl h-[80vh] p-8 md:p-12 overflow-y-auto font-typewriter text-2xl leading-loose ${paperType}`;
                paperSelectionScreen.classList.add('hidden');
                writingScreen.classList.remove('hidden');
                hiddenTextarea.focus();
                Tone.start();
            });
        });

        // 2. Simulação da Digitação
        paper.addEventListener('click', () => { hiddenTextarea.focus(); });
        hiddenTextarea.addEventListener('input', (e) => {
            currentText = e.target.value;
            paperContent.innerHTML = currentText.replace(/\n/g, '<br>');
            keyClickSound.triggerAttack('C2');
            paper.scrollTop = paper.scrollHeight;
        });
        hiddenTextarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                plingSound.triggerAttackRelease('C5', '8n', Tone.now());
                carriageReturnSound.triggerAttackRelease('0.1', Tone.now() + 0.1);
            } else if (e.key === 'Backspace') {
                keyClickSound.triggerAttack('A1');
            }
        });

        // 3. Controles
        btnBack.addEventListener('click', () => {
            hiddenTextarea.value = '';
            currentText = '';
            paperContent.innerHTML = '';
            writingScreen.classList.add('hidden');
            paperSelectionScreen.classList.remove('hidden');
        });

        btnEmail.addEventListener('click', () => {
            const subject = "Uma carta do Ateliê Epistolar";
            const body = encodeURIComponent(currentText);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });

        // NOVA LÓGICA: Gerar e baixar o PDF
        btnPdf.addEventListener('click', () => {
            // Esconde o cursor piscando para não aparecer no PDF
            cursor.style.display = 'none';
            btnPdf.textContent = 'A gerar...';
            btnPdf.disabled = true;

            const element = document.getElementById('paper');
            const options = {
                margin:       [0.5, 0.5, 0.5, 0.5], // top, left, bottom, right in inches
                filename:     'carta_atelie_epistolar.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, logging: false },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Usa a biblioteca para criar o PDF a partir do elemento 'paper'
            html2pdf().set(options).from(element).save().then(() => {
                // Quando o processo terminar, restaura o botão e o cursor
                cursor.style.display = 'inline-block';
                btnPdf.textContent = 'Baixar em PDF';
                btnPdf.disabled = false;
            }).catch((err) => {
                console.error("Erro ao gerar PDF:", err);
                // Restaura o botão mesmo em caso de erro
                cursor.style.display = 'inline-block';
                btnPdf.textContent = 'Baixar em PDF';
                btnPdf.disabled = false;
            });
        });

    </script>
</body>
</html>

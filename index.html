<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ateliê Epistolar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Special+Elite&family=Caveat:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-typewriter { font-family: 'Special Elite', monospace; }
        .font-quill { font-family: 'Caveat', cursive; font-size: 2.25rem; line-height: 2.5rem; }

        #hidden-textarea { position: absolute; left: -9999px; top: 0; opacity: 0; }
        #paper, .letter-view { box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: all 0.3s ease-in-out; position: relative; }
        #paper { cursor: text; overflow-y: auto; }
        .paper-linho-marfim { background-color: #FDFBF5; border: 1px solid #EAE6DA; }
        .paper-pergaminho-salinas { background-color: #F5EEDC; background-image: linear-gradient(rgba(210, 180, 140, 0.15) 1px, transparent 1px), linear-gradient(90deg, rgba(210, 180, 140, 0.15) 1px, transparent 1px); background-size: 20px 20px; border: 1px solid #D2B48C; box-shadow: 0 10px 30px rgba(80, 50, 20, 0.2); }
        .paper-rascunho-poeta { background-color: #FFFFFF; background-image: repeating-linear-gradient(to bottom, transparent, transparent 24px, #E2E8F0 24px, #E2E8F0 25px); border-left: 3px solid #F87171; }
        #cursor { display: inline-block; width: 8px; height: 1.2em; background-color: #333; animation: blink 1s step-end infinite; vertical-align: bottom; }
        @keyframes blink { from, to { background-color: transparent; } 50% { background-color: #333; } }
        .control-button { transition: all 0.2s ease; }
        .control-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .control-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .choice-card { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .choice-card:hover { transform: scale(1.03); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .letter-thumbnail-wrapper { position: relative; }
        .letter-thumbnail { height: 250px; padding: 1rem; overflow: hidden; position: relative; cursor: pointer; border-radius: 0.5rem; }
        .letter-thumbnail::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 50px; background: linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0)); }
        .paper-linho-marfim.letter-thumbnail::after { background: linear-gradient(to top, #FDFBF5, rgba(253,251,245,0)); }
        .paper-pergaminho-salinas.letter-thumbnail::after { background: linear-gradient(to top, #F5EEDC, rgba(245,238,220,0)); }
        .delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(239, 68, 68, 0.8); color: white; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; line-height: 1; cursor: pointer; opacity: 0; transition: opacity 0.2s ease; }
        .letter-thumbnail-wrapper:hover .delete-btn { opacity: 1; }

        #btn-challenge { position: absolute; top: 1rem; right: 1rem; background-color: rgba(255, 255, 255, 0.7); border-radius: 50%; padding: 0.5rem; cursor: pointer; transition: all 0.2s ease; }
        #btn-challenge:hover { transform: scale(1.1); background-color: rgba(255, 255, 255, 1); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- TELA 1: MENU PRINCIPAL (ATUALIZADO) -->
    <div id="main-screen" class="w-full max-w-4xl text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 font-typewriter">Ateliê Epistolar</h1>
        <div class="text-lg text-gray-600 mb-12 mx-auto max-w-2xl space-y-4">
            <p>Num tempo de palavras apressadas, que nascem e morrem no mesmo instante, este é um refúgio.</p>
            <p>Um lugar para a pausa, para o pensamento que respira antes de se tornar tinta. Bem-vindo.</p>
        </div>
        <div class="flex justify-center items-center">
            <button id="btn-new-letter" class="control-button bg-gray-800 text-white font-bold py-4 px-8 rounded-lg text-xl">Escrever Nova Carta</button>
        </div>
    </div>

    <!-- TELA 2: ESCOLHA DO INSTRUMENTO -->
    <div id="instrument-selection-screen" class="hidden w-full max-w-4xl text-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-4 font-typewriter">Passo Um</h1>
        <p class="text-lg text-gray-600 mb-12">Escolha o seu instrumento de escrita.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="instrument-option choice-card bg-white p-8 rounded-lg shadow-md" data-instrument="typewriter"><h2 class="text-3xl font-bold mb-4 font-typewriter">Máquina de Escrever</h2><p class="text-gray-600">Para a palavra precisa, com o som metálico e o ritmo da História.</p></div>
            <div class="instrument-option choice-card bg-white p-8 rounded-lg shadow-md" data-instrument="quill"><h2 class="text-3xl font-bold mb-4 font-quill">Pena e Tinteiro</h2><p class="text-gray-600">Para o pensamento fluido, com o silêncio da pena a deslizar no papel.</p></div>
        </div>
        <button id="btn-back-to-main-menu-1" class="mt-8 text-gray-600 hover:text-gray-800 font-semibold">Voltar ao Menu</button>
    </div>

    <!-- TELA 3: SELEÇÃO DE PAPEL -->
    <div id="paper-selection-screen" class="hidden w-full max-w-4xl text-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-4 font-typewriter">Passo Dois</h1>
        <p class="text-lg text-gray-600 mb-12">Agora, escolha o material.</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="paper-option choice-card bg-white p-6 rounded-lg shadow-md" data-paper-type="paper-linho-marfim"><div class="w-full h-32 paper-linho-marfim rounded mb-4 border"></div><h2 class="text-xl font-bold mb-2">Papel Linho Marfim</h2></div>
            <div class="paper-option choice-card bg-white p-6 rounded-lg shadow-md" data-paper-type="paper-pergaminho-salinas"><div class="w-full h-32 paper-pergaminho-salinas rounded mb-4 border"></div><h2 class="text-xl font-bold mb-2">Pergaminho "Salinas, 1920"</h2></div>
            <div class="paper-option choice-card bg-white p-6 rounded-lg shadow-md" data-paper-type="paper-rascunho-poeta"><div class="w-full h-32 paper-rascunho-poeta rounded mb-4 border"></div><h2 class="text-xl font-bold mb-2">Rascunho do Poeta</h2></div>
        </div>
        <button id="btn-back-to-instrument" class="mt-8 text-gray-600 hover:text-gray-800 font-semibold">Voltar</button>
    </div>

    <!-- TELA 4: ESCRITA DA CARTA (ATUALIZADO) -->
    <div id="writing-screen" class="hidden w-full h-screen flex flex-col items-center p-2 sm:p-4">
        <textarea id="hidden-textarea" autofocus></textarea>
        <div id="paper" class="w-full max-w-3xl flex-grow p-8 md:p-12 text-2xl leading-loose">
            <span id="paper-content"></span><span id="cursor"></span>
            <button id="btn-challenge"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg></button>
        </div>
        <div class="w-full max-w-3xl mt-4 flex-shrink-0">
            <div id="controls" class="flex flex-wrap gap-2 sm:gap-4 justify-center">
                <button id="btn-publish" class="control-button bg-indigo-600 text-white font-bold py-2 px-4 sm:px-5 rounded-lg text-sm sm:text-base" disabled>Publicar na Galeria</button>
                <button id="btn-view-gallery" class="control-button bg-blue-600 text-white font-bold py-2 px-4 sm:px-5 rounded-lg text-sm sm:text-base">Ver Galeria</button>
                <button id="btn-pdf" class="control-button bg-green-600 text-white font-bold py-2 px-4 sm:px-5 rounded-lg text-sm sm:text-base" disabled>Baixar em PDF</button>
                <button id="btn-back" class="control-button bg-gray-500 text-white font-bold py-2 px-4 sm:px-5 rounded-lg text-sm sm:text-base">Começar de Novo</button>
            </div>
            <div id="feedback-message" class="mt-2 h-6 text-center font-semibold opacity-0 transition-opacity"></div>
        </div>
    </div>

    <!-- TELA 5: GALERIA -->
    <div id="gallery-screen" class="hidden w-full max-w-6xl text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 font-typewriter">Galeria de Cartas</h1>
        <p class="text-lg text-gray-600 mb-12">Toque numa carta para a ler ou no '×' para a excluir.</p>
        <div id="gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8"></div>
        <button id="btn-back-to-main-2" class="control-button mt-12 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg">Voltar ao Menu</button>
    </div>

    <!-- TELA 6: LEITOR DE CARTA (MODAL) -->
    <div id="letter-viewer-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div id="letter-view" class="letter-view w-full max-w-3xl h-[90vh] p-8 md:p-12 overflow-y-auto relative bg-white">
            <p id="letter-viewer-content"></p>
        </div>
        <button id="btn-close-viewer" class="absolute top-4 right-4 text-white text-5xl font-bold">&times;</button>
    </div>

    <!-- TELA 7: MODAL DE DESAFIO -->
    <div id="challenge-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full text-center relative">
            <h2 class="text-2xl font-bold mb-4">Desafio Criativo</h2>
            <p id="challenge-text" class="text-lg text-gray-700 mb-8"></p>
            <button id="btn-close-challenge" class="control-button bg-gray-800 text-white font-bold py-2 px-6 rounded-lg">Fechar</button>
        </div>
    </div>

    <script>
        // --- Elementos do DOM ---
        const screens = {
            main: document.getElementById('main-screen'),
            instrument: document.getElementById('instrument-selection-screen'),
            paper: document.getElementById('paper-selection-screen'),
            writing: document.getElementById('writing-screen'),
            gallery: document.getElementById('gallery-screen'),
            viewer: document.getElementById('letter-viewer-modal'),
            challenge: document.getElementById('challenge-modal')
        };
        const btnNewLetter = document.getElementById('btn-new-letter');
        const instrumentOptions = document.querySelectorAll('.instrument-option');
        const paperOptions = document.querySelectorAll('.paper-option');
        const paper = document.getElementById('paper');
        const paperContent = document.getElementById('paper-content');
        const hiddenTextarea = document.getElementById('hidden-textarea');
        const btnPdf = document.getElementById('btn-pdf');
        const btnBack = document.getElementById('btn-back');
        const btnBackToInstrument = document.getElementById('btn-back-to-instrument');
        const btnBackToMainMenu1 = document.getElementById('btn-back-to-main-menu-1');
        const btnPublish = document.getElementById('btn-publish');
        const btnViewGallery = document.getElementById('btn-view-gallery'); 
        const btnBackToMain2 = document.getElementById('btn-back-to-main-2');
        const btnCloseViewer = document.getElementById('btn-close-viewer');
        const galleryGrid = document.getElementById('gallery-grid');
        const letterView = document.getElementById('letter-view');
        const letterViewerContent = document.getElementById('letter-viewer-content');
        const cursor = document.getElementById('cursor');
        const feedbackMessage = document.getElementById('feedback-message');
        const btnChallenge = document.getElementById('btn-challenge');
        const challengeText = document.getElementById('challenge-text');
        const btnCloseChallenge = document.getElementById('btn-close-challenge');

        let currentText = '';
        let chosenInstrument = 'typewriter';
        let chosenPaper = 'paper-linho-marfim';
        let letters = [];

        // --- Sons ---
        const keyClickSound = new Tone.MembraneSynth({ "pitchDecay": 0.01, "octaves": 6, "oscillator": { "type": "square" }, "envelope": { "attack": 0.001, "decay": 0.2, "sustain": 0.01, "release": 0.2, }}).toDestination();
        keyClickSound.volume.value = -10;
        
        // --- Lógica de Navegação ---
        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        btnNewLetter.addEventListener('click', () => showScreen('instrument'));
        btnViewGallery.addEventListener('click', () => {
            renderGallery();
            showScreen('gallery');
        });
        btnBackToMainMenu1.addEventListener('click', () => showScreen('main'));
        btnBackToInstrument.addEventListener('click', () => showScreen('instrument'));
        btnBackToMain2.addEventListener('click', () => showScreen('main'));
        btnCloseViewer.addEventListener('click', () => screens.viewer.classList.add('hidden'));

        instrumentOptions.forEach(option => {
            option.addEventListener('click', () => {
                chosenInstrument = option.dataset.instrument;
                showScreen('paper');
            });
        });

        paperOptions.forEach(option => {
            option.addEventListener('click', () => {
                chosenPaper = option.dataset.paperType;
                const fontClass = chosenInstrument === 'typewriter' ? 'font-typewriter' : 'font-quill';
                paper.className = `w-full max-w-3xl flex-grow p-8 md:p-12 text-2xl leading-loose ${chosenPaper} ${fontClass}`;
                showScreen('writing');
                hiddenTextarea.focus();
                Tone.start();
            });
        });
        
        btnBack.addEventListener('click', () => {
            hiddenTextarea.value = '';
            currentText = '';
            paperContent.innerHTML = '';
            btnPdf.disabled = true;
            btnPublish.disabled = true;
            showScreen('main');
        });

        // --- Lógica de Escrita ---
        paper.addEventListener('click', () => { hiddenTextarea.focus(); });
        hiddenTextarea.addEventListener('input', (e) => {
            currentText = e.target.value;
            const hasText = currentText.length > 0;
            btnPdf.disabled = !hasText;
            btnPublish.disabled = !hasText;
            paperContent.innerHTML = currentText.replace(/\n/g, '<br>');
            
            if (chosenInstrument === 'typewriter') {
                keyClickSound.triggerAttackRelease('C2', '32n');
            }
            paper.scrollTop = paper.scrollHeight;
        });
        
        // --- Lógica da Galeria ---
        function loadLetters() {
            const storedLetters = localStorage.getItem('atelie-letters');
            if (storedLetters) {
                letters = JSON.parse(storedLetters);
            }
        }

        function saveLetters() {
            localStorage.setItem('atelie-letters', JSON.stringify(letters));
        }

        function renderGallery() {
            galleryGrid.innerHTML = '';
            if (letters.length === 0) {
                galleryGrid.innerHTML = `<p class="text-gray-500 col-span-full">A sua galeria está vazia. Escreva e publique uma carta para a começar.</p>`;
                return;
            }
            letters.forEach(letter => {
                const fontClass = letter.instrument === 'typewriter' ? 'font-typewriter' : 'font-quill';
                const snippet = letter.text.substring(0, 200) + (letter.text.length > 200 ? '...' : '');
                
                const wrapper = document.createElement('div');
                wrapper.className = 'letter-thumbnail-wrapper';

                const thumbnail = document.createElement('div');
                thumbnail.className = `letter-thumbnail choice-card ${letter.paper} ${fontClass}`;
                thumbnail.innerHTML = `<p>${snippet.replace(/\n/g, '<br>')}</p>`;
                thumbnail.addEventListener('click', () => viewUserLetter(letter.id));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteLetter(letter.id);
                });

                wrapper.appendChild(thumbnail);
                wrapper.appendChild(deleteBtn);
                galleryGrid.appendChild(wrapper);
            });
        }

        function deleteLetter(id) {
            letters = letters.filter(l => l.id !== id);
            saveLetters();
            renderGallery();
        }

        function viewUserLetter(id) {
            const letter = letters.find(l => l.id === id);
            if (!letter) return;
            
            const fontClass = letter.instrument === 'typewriter' ? 'font-typewriter' : 'font-quill';
            letterView.className = `letter-view w-full max-w-3xl h-[90vh] p-8 md:p-12 overflow-y-auto relative ${letter.paper} ${fontClass}`;
            letterViewerContent.innerHTML = letter.text.replace(/\n/g, '<br>');
            showScreen('viewer');
        }

        btnPublish.addEventListener('click', () => {
            const newLetter = {
                id: Date.now(),
                text: currentText,
                instrument: chosenInstrument,
                paper: chosenPaper
            };
            letters.unshift(newLetter);
            saveLetters();
            showFeedback('Carta publicada na sua galeria!');
        });

        // --- Lógica dos Desafios ---
        const writingChallenges = [
            "Imagine que é um cidadão de Salinas da Margarida em 1950. Escreva uma carta a um parente distante a descrever o seu dia-a-dia na cidade.",
            "Comece a sua carta com o verso: 'A chuva de ontem deixou mais do que saudade...'",
            "Escreva uma carta ao seu 'eu' de dez anos no futuro. Que conselho, ou aviso, lhe daria?",
            "Escolha uma personagem secundária de um livro que admira. Escreva uma carta do ponto de vista dela, revelando um segredo.",
            "Escreva uma carta de protesto contra uma injustiça social da sua época, como se a estivesse a enviar para um jornal em 1970.",
            "Descreva o sabor de uma fruta da sua infância a alguém que nunca a provou."
        ];

        btnChallenge.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * writingChallenges.length);
            challengeText.textContent = writingChallenges[randomIndex];
            screens.challenge.classList.remove('hidden');
        });

        btnCloseChallenge.addEventListener('click', () => {
            screens.challenge.classList.add('hidden');
        });

        // --- GERAR PDF ---
        function showFeedback(message, isError = false) {
            feedbackMessage.textContent = message;
            feedbackMessage.className = isError 
                ? 'mt-2 h-6 text-center font-semibold opacity-100 transition-opacity text-red-600'
                : 'mt-2 h-6 text-center font-semibold opacity-100 transition-opacity text-green-700';
            setTimeout(() => { feedbackMessage.classList.replace('opacity-100', 'opacity-0'); }, 3000);
        }

        btnPdf.addEventListener('click', () => {
            cursor.style.display = 'none';
            const element = document.getElementById('paper');
            const options = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: 'carta_atelie_epistolar.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            setTimeout(() => {
                html2pdf().set(options).from(element).save().then(() => {
                    cursor.style.display = 'inline-block';
                    showFeedback('Carta guardada com sucesso!');
                }).catch(err => {
                    console.error("Erro ao gerar PDF:", err);
                    showFeedback('Ocorreu um erro ao guardar a carta.', true);
                    cursor.style.display = 'inline-block';
                });
            }, 200);
        });

        // --- Inicialização ---
        loadLetters();
        showScreen('main');

    </script>
</body>
</html>

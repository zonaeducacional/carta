<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ateli√™ Epistolar</title>
    
    <!-- CDN Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- SCRIPTS DO FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Special+Elite&family=Caveat:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'typewriter': ['Special Elite', 'monospace'],
                        'quill': ['Caveat', 'cursive'],
                        'serif': ['Playfair Display', 'serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(30px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        float: { '0%, 100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' } },
                        pulseSoft: { '0%, 100%': { opacity: '0.8' }, '50%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .font-typewriter { font-family: 'Special Elite', monospace; }
        .font-quill { font-family: 'Caveat', cursive; }
        .font-serif { font-family: 'Playfair Display', serif; }
        #hidden-textarea { position: absolute; left: -9999px; top: 0; opacity: 0; pointer-events: none; }
        #paper, .letter-view { box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.5) inset; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; backdrop-filter: blur(10px); }
        #paper { cursor: text; overflow-y: auto; border-radius: 12px; }
        #paper:hover { transform: translateY(-2px); box-shadow: 0 25px 50px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.6) inset; }
        /* Paper Styles */
        .paper-linho-marfim { background: linear-gradient(145deg, #FDFBF5 0%, #F8F6F0 100%); border: 1px solid #EAE6DA; }
        .paper-pergaminho-salinas { background: linear-gradient(145deg, #F5EEDC 0%, #F0E7D5 100%), linear-gradient(rgba(210, 180, 140, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(210, 180, 140, 0.1) 1px, transparent 1px); background-size: 100% 100%, 20px 20px, 20px 20px; border: 1px solid #D2B48C; box-shadow: 0 20px 40px rgba(80, 50, 20, 0.15), 0 0 0 1px rgba(255,255,255,0.3) inset; }
        .paper-rascunho-poeta { background: linear-gradient(145deg, #FFFFFF 0%, #FAFAFA 100%), repeating-linear-gradient(to bottom, transparent, transparent 24px, #E2E8F0 24px, #E2E8F0 25px); border-left: 4px solid #F87171; border-radius: 12px 12px 12px 0; }
        /* Cursor Animation */
        #cursor { display: inline-block; width: 2px; height: 1.2em; background: linear-gradient(45deg, #333, #666); animation: blink 1.2s step-end infinite; vertical-align: bottom; border-radius: 1px; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        /* Interactive Elements */
        .control-button { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .control-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .control-button:hover::before { left: 100%; }
        .control-button:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .control-button:active:not(:disabled) { transform: translateY(-1px) scale(0.98); }
        .control-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .choice-card { cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .choice-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px rgba(0,0,0,0.15); border-color: rgba(99, 102, 241, 0.3); }
        /* Challenge Button */
        #btn-challenge { position: absolute; top: 1.5rem; right: 1.5rem; background: rgba(255, 255, 255, 0.9); border-radius: 50%; padding: 0.75rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        #btn-challenge:hover { transform: scale(1.15) rotate(5deg); background: rgba(255, 255, 255, 1); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        /* Modal Styles */
        .modal-backdrop { backdrop-filter: blur(8px); background: rgba(0, 0, 0, 0.6); }
        .modal-content { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); }
        /* Loading Animation */
        .loading-dots { display: inline-block; }
        .loading-dots::after { content: ''; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
        /* Responsive & Accessibility */
        @media (max-width: 640px) { .choice-card:hover { transform: translateY(-4px) scale(1.01); } #paper { border-radius: 8px; } }
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; } }
        .control-button:focus, .choice-card:focus { outline: 2px solid #6366f1; outline-offset: 2px; }
        /* Custom Scrollbar */
        #paper::-webkit-scrollbar { width: 8px; } #paper::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; } #paper::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.3); border-radius: 4px; } #paper::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.5); }
        
        /* --- ESTILOS PARA A GALERIA DE ENVELOPES --- */
        .envelope-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1.5 / 1;
            cursor: pointer;
            perspective: 1000px;
            -webkit-perspective: 1000px;
            transition: transform 0.3s ease;
        }
        .envelope-wrapper:hover {
            transform: translateY(-10px);
        }
        .envelope-wrapper:hover .letter-paper {
            transform: translateY(-60%);
        }
        .envelope {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .envelope-back {
            background-color: #e0d8c7;
            background-image: linear-gradient(135deg, #f0e8d7 0%, #d8cfbc 100%);
            z-index: 1;
        }
        .letter-paper {
            position: absolute;
            top: 0; left: 5%; right: 5%;
            height: 90%;
            background: #fff;
            z-index: 2;
            padding: 1.2rem 1.2rem 4rem;
            overflow: hidden;
            border-radius: 6px;
            transform: translateY(-45%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .letter-paper::after {
             content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 60px;
             background: linear-gradient(to top, rgba(255,255,255,1) 30%, rgba(255,255,255,0));
        }
        .envelope-flap {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 55%;
            background-color: #e0d8c7;
            background-image: linear-gradient(to bottom, #d8cfbc 0%, #f0e8d7 100%);
            transform-origin: top;
            transition: transform 0.5s ease-in-out;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            z-index: 4;
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
        }
        .envelope-front {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 3;
            background: #e0d8c7;
            clip-path: polygon(0% 100%, 100% 100%, 100% 45%, 50% 100%, 0 45%);
        }
        .delete-btn-gallery {
            position: absolute; top: -15px; right: -15px;
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white; border-radius: 50%; width: 2.5rem; height: 2.5rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; line-height: 1; font-weight: bold;
            cursor: pointer; z-index: 10;
            opacity: 0; transform: scale(0.8);
            transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .envelope-wrapper:hover .delete-btn-gallery {
            opacity: 1; transform: scale(1);
        }
        .delete-btn-gallery:hover {
            transform: scale(1.15) rotate(5deg);
        }
    </style>
</head>
<body class="text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- TELA 1: MENU PRINCIPAL -->
    <div id="main-screen" class="w-full max-w-5xl text-center animate-fade-in">
        <div class="mb-8">
            <h1 class="text-5xl md:text-7xl font-bold mb-6 font-serif bg-gradient-to-r from-gray-800 via-gray-600 to-gray-800 bg-clip-text text-transparent animate-pulse-soft">Ateli√™ Epistolar</h1>
            <div class="w-24 h-1 bg-gradient-to-r from-transparent via-gray-400 to-transparent mx-auto mb-8"></div>
        </div>
        <div class="text-xl text-gray-600 mb-16 mx-auto max-w-3xl space-y-6 font-light leading-relaxed">
            <p class="animate-slide-up" style="animation-delay: 0.2s;">Num tempo de palavras apressadas, que nascem e morrem no mesmo instante, este √© um ref√∫gio.</p>
            <p class="animate-slide-up" style="animation-delay: 0.4s;">"Uma carta √© a prova de que um pensamento foi t√£o importante que mereceu ser vestido com papel e enviado para morar em outras m√£os."</p>
            <p class="animate-slide-up font-medium text-gray-700" style="animation-delay: 0.6s;">Bem-vindo ao seu santu√°rio da palavra escrita.</p>
            <a href="https://web2.nekoweb.org/exemplodecartas" target="_blank" rel="noopener noreferrer"><strong>Inspire-se</strong></a>
        </div>
        <div class="flex flex-col sm:flex-row gap-6 justify-center items-center animate-slide-up" style="animation-delay: 0.8s;">
            <button id="btn-new-letter" class="control-button bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600 text-white font-semibold py-4 px-10 rounded-xl text-xl shadow-lg">‚úçÔ∏è Escrever Nova Carta</button>
            <button id="btn-view-gallery-main" class="control-button bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold py-4 px-10 rounded-xl text-xl shadow-lg">üìö Ver Galeria</button>
        </div>
    </div>

    <!-- TELA 2: ESCOLHA DO INSTRUMENTO -->
    <div id="instrument-selection-screen" class="hidden w-full max-w-5xl text-center animate-fade-in">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 font-serif text-gray-800">Passo Um</h1>
        <p class="text-xl text-gray-600 mb-16 font-light">Escolha o seu instrumento de escrita.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-12">
            <div class="instrument-option choice-card p-10 rounded-2xl shadow-xl" data-instrument="typewriter">
                <div class="text-6xl mb-6 animate-float">‚å®Ô∏è</div>
                <h2 class="text-3xl font-bold mb-4 font-typewriter text-gray-800">M√°quina de Escrever</h2>
                <p class="text-gray-600 text-lg leading-relaxed">Para a palavra precisa, com o som met√°lico e o ritmo da Hist√≥ria.</p>
            </div>
            <div class="instrument-option choice-card p-10 rounded-2xl shadow-xl" data-instrument="quill">
                <div class="text-6xl mb-6 animate-float" style="animation-delay: 0.5s;">ü™∂</div>
                <h2 class="text-3xl font-bold mb-4 font-quill text-gray-800">Pena e Tinteiro</h2>
                <p class="text-gray-600 text-lg leading-relaxed">Para o pensamento fluido, com o sil√™ncio da pena a deslizar no papel.</p>
            </div>
        </div>
        <button id="btn-back-to-main-menu-1" class="text-gray-500 hover:text-gray-700 font-semibold text-lg transition-colors duration-300">‚Üê Voltar ao Menu</button>
    </div>

    <!-- TELA 3: SELE√á√ÉO DE PAPEL -->
    <div id="paper-selection-screen" class="hidden w-full max-w-6xl text-center animate-fade-in">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 font-serif text-gray-800">Passo Dois</h1>
        <p class="text-xl text-gray-600 mb-16 font-light">Agora, escolha o material.</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10 mb-12">
            <div class="paper-option choice-card p-8 rounded-2xl shadow-xl" data-paper-type="paper-linho-marfim"><div class="w-full h-40 paper-linho-marfim rounded-xl mb-6 border-2 border-gray-200 shadow-inner"></div><h2 class="text-xl font-semibold mb-2 text-gray-800">Papel Linho Marfim</h2><p class="text-gray-600 text-sm">Elegante e cl√°ssico</p></div>
            <div class="paper-option choice-card p-8 rounded-2xl shadow-xl" data-paper-type="paper-pergaminho-salinas"><div class="w-full h-40 paper-pergaminho-salinas rounded-xl mb-6 border-2 border-gray-200 shadow-inner"></div><h2 class="text-xl font-semibold mb-2 text-gray-800">Pergaminho "Salinas, 1920"</h2><p class="text-gray-600 text-sm">Vintage e nost√°lgico</p></div>
            <div class="paper-option choice-card p-8 rounded-2xl shadow-xl" data-paper-type="paper-rascunho-poeta"><div class="w-full h-40 paper-rascunho-poeta rounded-xl mb-6 border-2 border-gray-200 shadow-inner"></div><h2 class="text-xl font-semibold mb-2 text-gray-800">Rascunho do Poeta</h2><p class="text-gray-600 text-sm">Criativo e inspirador</p></div>
        </div>
        <button id="btn-back-to-instrument" class="text-gray-500 hover:text-gray-700 font-semibold text-lg transition-colors duration-300">‚Üê Voltar</button>
    </div>

    <!-- TELA 4: ESCRITA DA CARTA -->
    <div id="writing-screen" class="hidden w-full h-screen flex flex-col items-center p-2 sm:p-4 animate-fade-in">
        <textarea id="hidden-textarea" autofocus aria-label="Campo de texto oculto para captura de entrada"></textarea>
        <div id="paper" class="w-full max-w-4xl flex-grow p-8 md:p-16 text-2xl leading-loose relative" role="textbox" aria-label="√Årea de escrita da carta">
            <span id="paper-content"></span><span id="cursor"></span>
            <button id="btn-challenge" aria-label="Obter desafio criativo" title="Desafio Criativo">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
            </button>
        </div>
        <div class="w-full max-w-4xl mt-6 flex-shrink-0">
            <div id="controls" class="flex flex-wrap gap-3 sm:gap-4 justify-center mb-4">
                <button id="btn-publish" class="control-button bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-base shadow-lg" disabled>üì§ Publicar na Galeria</button>
                <button id="btn-view-gallery" class="control-button bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-base shadow-lg">üìö Ver Galeria</button>
                <button id="btn-pdf" class="control-button bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-base shadow-lg" disabled>üìÑ Baixar PDF</button>
                <button id="btn-back" class="control-button bg-gradient-to-r from-gray-500 to-gray-400 hover:from-gray-400 hover:to-gray-300 text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-base shadow-lg">üîÑ Come√ßar de Novo</button>
            </div>
            <div id="feedback-message" class="mt-3 h-8 text-center font-semibold opacity-0 transition-all duration-300 text-lg"></div>
        </div>
    </div>

    <!-- TELA 5: GALERIA -->
    <div id="gallery-screen" class="hidden w-full max-w-7xl text-center animate-fade-in">
        <h1 class="text-4xl md:text-6xl font-bold mb-4 font-serif text-gray-800">Galeria de Cartas</h1>
        <p class="text-lg text-gray-600 mb-16 font-light">Clique num envelope para ler a carta. Passe o mouse para excluir.</p>
        <div id="gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-12 mb-12">
            <!-- Os envelopes ser√£o inseridos aqui pelo JavaScript -->
        </div>
        <button id="btn-back-to-main-2" class="control-button bg-gradient-to-r from-gray-500 to-gray-400 hover:from-gray-400 hover:to-gray-300 text-white font-semibold py-4 px-8 rounded-xl shadow-lg">
            ‚Üê Voltar ao Menu
        </button>
    </div>

    <!-- TELA 6: LEITOR DE CARTA (MODAL) -->
    <div id="letter-viewer-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="letter-viewer-title">
        <div id="letter-view" class="letter-view modal-content w-full max-w-4xl h-[90vh] p-8 md:p-16 overflow-y-auto relative rounded-2xl shadow-2xl">
            <h2 id="letter-viewer-title" class="sr-only">Visualizador de Carta</h2>
            <p id="letter-viewer-content" class="text-lg leading-relaxed"></p>
        </div>
        <button id="btn-close-viewer" class="absolute top-4 right-4 text-gray-800 bg-white/70 backdrop-blur-sm rounded-full w-12 h-12 flex items-center justify-center text-3xl font-bold hover:scale-110 hover:bg-white transition-all duration-200 shadow-lg" aria-label="Fechar visualizador">&times;</button>
    </div>

    <!-- TELA 7: MODAL DE DESAFIO -->
    <div id="challenge-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="challenge-title">
        <div class="modal-content rounded-2xl shadow-2xl p-10 max-w-2xl w-full text-center relative">
            <h2 id="challenge-title" class="text-3xl font-bold mb-6 text-gray-800 font-serif">üí° Desafio Criativo</h2>
            <p id="challenge-text" class="text-xl text-gray-700 mb-10 leading-relaxed font-light"></p>
            <button id="btn-close-challenge" class="control-button bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600 text-white font-semibold py-3 px-8 rounded-xl shadow-lg">Fechar</button>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="modal-content rounded-2xl p-8 text-center">
            <div class="text-4xl mb-4">‚è≥</div>
            <p class="text-xl text-gray-700">Processando<span class="loading-dots"></span></p>
        </div>
    </div>

    <script>
        // --- INICIALIZA√á√ÉO DO FIREBASE COM A SUA CONFIGURA√á√ÉO ---
        const firebaseConfig = {
            apiKey: "AIzaSyAYbDpQ1mg9w1I2_VqCV-8KR1tVKTCjwSA",
            authDomain: "atelie-epistolar.firebaseapp.com",
            projectId: "atelie-epistolar",
            storageBucket: "atelie-epistolar.appspot.com", // Corrigido para .appspot.com
            messagingSenderId: "552526217927",
            appId: "1:552526217927:web:89e01cc0a21bc9347274e2"
        };
        
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch(e) {
            console.error("Erro ao inicializar o Firebase. Verifique a configura√ß√£o e os scripts.", e);
            alert("N√£o foi poss√≠vel conectar ao banco de dados. O aplicativo funcionar√° em modo offline.");
        }
        
        // --- Elementos do DOM ---
        const screens = { main: document.getElementById('main-screen'), instrument: document.getElementById('instrument-selection-screen'), paper: document.getElementById('paper-selection-screen'), writing: document.getElementById('writing-screen'), gallery: document.getElementById('gallery-screen'), viewer: document.getElementById('letter-viewer-modal'), challenge: document.getElementById('challenge-modal'), loading: document.getElementById('loading-indicator') };
        const elements = { btnNewLetter: document.getElementById('btn-new-letter'), btnViewGalleryMain: document.getElementById('btn-view-gallery-main'), instrumentOptions: document.querySelectorAll('.instrument-option'), paperOptions: document.querySelectorAll('.paper-option'), paper: document.getElementById('paper'), paperContent: document.getElementById('paper-content'), hiddenTextarea: document.getElementById('hidden-textarea'), btnPdf: document.getElementById('btn-pdf'), btnBack: document.getElementById('btn-back'), btnBackToInstrument: document.getElementById('btn-back-to-instrument'), btnBackToMainMenu1: document.getElementById('btn-back-to-main-menu-1'), btnPublish: document.getElementById('btn-publish'), btnViewGallery: document.getElementById('btn-view-gallery'), btnBackToMain2: document.getElementById('btn-back-to-main-2'), btnCloseViewer: document.getElementById('btn-close-viewer'), galleryGrid: document.getElementById('gallery-grid'), letterView: document.getElementById('letter-view'), letterViewerContent: document.getElementById('letter-viewer-content'), cursor: document.getElementById('cursor'), feedbackMessage: document.getElementById('feedback-message'), btnChallenge: document.getElementById('btn-challenge'), challengeText: document.getElementById('challenge-text'), btnCloseChallenge: document.getElementById('btn-close-challenge') };

        // --- Estado da Aplica√ß√£o ---
        let state = { currentText: '', chosenInstrument: 'typewriter', chosenPaper: 'paper-linho-marfim', letters: [], isTyping: false };

        // --- Sistema de Som ---
        let keyClickSound = null;
        function initializeAudio() { if (!keyClickSound) { try { keyClickSound = new Tone.MembraneSynth({ "pitchDecay": 0.01, "octaves": 6, "oscillator": { "type": "square" }, "envelope": { "attack": 0.001, "decay": 0.2, "sustain": 0.01, "release": 0.2, } }).toDestination(); keyClickSound.volume.value = -12; } catch (error) { console.warn('√Åudio n√£o dispon√≠vel:', error); } } }

        // --- Utilit√°rios ---
        function showScreen(screenName) { Object.values(screens).forEach(screen => screen.classList.add('hidden')); screens[screenName].classList.remove('hidden'); }
        function showFeedback(message, type = 'success') { const colors = { success: 'text-green-600', error: 'text-red-600', info: 'text-blue-600' }; elements.feedbackMessage.textContent = message; elements.feedbackMessage.className = `mt-3 h-8 text-center font-semibold transition-all duration-300 text-lg ${colors[type]}`; elements.feedbackMessage.style.opacity = '1'; setTimeout(() => { elements.feedbackMessage.style.opacity = '0'; }, 3000); }
        function showLoading(show = true) { screens.loading.classList.toggle('hidden', !show); }

        // --- Navega√ß√£o ---
        function setupNavigation() {
            elements.btnNewLetter.addEventListener('click', () => showScreen('instrument'));
            elements.btnViewGalleryMain.addEventListener('click', () => { renderGallery(); showScreen('gallery'); });
            elements.btnViewGallery.addEventListener('click', () => { renderGallery(); showScreen('gallery'); });
            elements.btnBackToMainMenu1.addEventListener('click', () => showScreen('main'));
            elements.btnBackToInstrument.addEventListener('click', () => showScreen('instrument'));
            elements.btnBackToMain2.addEventListener('click', () => showScreen('main'));
            elements.btnCloseViewer.addEventListener('click', () => screens.viewer.classList.add('hidden'));

            // Adiciona a funcionalidade de fechar o modal ao clicar no fundo
            screens.viewer.addEventListener('click', (e) => {
                // Se o clique for no backdrop (o elemento pai) e n√£o nos filhos
                if (e.target === screens.viewer) {
                    screens.viewer.classList.add('hidden');
                }
            });

            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { screens.viewer.classList.add('hidden'); screens.challenge.classList.add('hidden'); } });
        }

        // --- Sele√ß√£o de Instrumentos e Pap√©is ---
        function setupSelections() {
            elements.instrumentOptions.forEach(option => { option.addEventListener('click', () => { state.chosenInstrument = option.dataset.instrument; showScreen('paper'); }); });
            elements.paperOptions.forEach(option => { option.addEventListener('click', () => { state.chosenPaper = option.dataset.paperType; const fontClass = state.chosenInstrument === 'typewriter' ? 'font-typewriter' : 'font-quill'; elements.paper.className = `w-full max-w-4xl flex-grow p-8 md:p-16 text-2xl leading-loose relative ${state.chosenPaper} ${fontClass}`; showScreen('writing'); elements.hiddenTextarea.focus(); initializeAudio(); if (keyClickSound) Tone.start(); }); });
        }
        
        // --- Sistema de Escrita ---
        function setupWriting() {
            elements.paper.addEventListener('click', () => { elements.hiddenTextarea.focus(); });
            elements.hiddenTextarea.addEventListener('input', (e) => {
                state.currentText = e.target.value;
                const hasText = state.currentText.trim().length > 0;
                elements.btnPdf.disabled = !hasText;
                elements.btnPublish.disabled = !hasText;
                elements.paperContent.innerHTML = state.currentText.replace(/\n/g, '<br>');
                if (state.chosenInstrument === 'typewriter' && keyClickSound && !state.isTyping) {
                    state.isTyping = true;
                    try { keyClickSound.triggerAttackRelease('C2', '32n'); } catch (error) { console.warn('Erro ao reproduzir som:', error); }
                    setTimeout(() => { state.isTyping = false; }, 50);
                }
                elements.paper.scrollTop = elements.paper.scrollHeight;
            });
            elements.btnBack.addEventListener('click', resetWriting);
        }
        function resetWriting() {
            elements.hiddenTextarea.value = '';
            state.currentText = '';
            elements.paperContent.innerHTML = '';
            elements.btnPdf.disabled = true;
            elements.btnPublish.disabled = true;
            showScreen('main');
        }

        // --- SISTEMA DE GALERIA COM FIREBASE ---
        async function loadLetters() {
            if (!db) { return; } // N√£o faz nada se o Firebase n√£o estiver conectado
            showLoading(true);
            try {
                const snapshot = await db.collection('letters').orderBy('timestamp', 'desc').get();
                state.letters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Erro ao carregar cartas do Firebase:", error);
                showFeedback('Erro ao carregar galeria', 'error');
                state.letters = [];
            } finally {
                showLoading(false);
            }
        }

        async function publishLetter() {
            if (!state.currentText.trim()) { showFeedback('Escreva algo antes de publicar!', 'error'); return; }
            if (!db) { showFeedback('N√£o foi poss√≠vel conectar ao banco de dados.', 'error'); return; }

            showLoading(true);
            const letter = {
                content: state.currentText,
                instrument: state.chosenInstrument,
                paperType: state.chosenPaper,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            try {
                await db.collection('letters').add(letter);
                showFeedback('Carta publicada na galeria!', 'success');
                resetWriting();
                renderGallery(); // Atualiza a galeria em segundo plano
                showScreen('gallery');
            } catch (error) {
                console.error("Erro ao publicar carta:", error);
                showFeedback('Erro ao publicar carta', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function deleteLetter(id, event) {
            event.stopPropagation();
            if (confirm('Tem certeza que deseja excluir esta carta permanentemente?')) {
                if (!db) { showFeedback('N√£o foi poss√≠vel conectar ao banco de dados.', 'error'); return; }
                showLoading(true);
                try {
                    await db.collection('letters').doc(id).delete();
                    await renderGallery();
                    showFeedback('Carta exclu√≠da', 'info');
                } catch (error) {
                    console.error("Erro ao excluir carta:", error);
                    showFeedback('Erro ao excluir carta', 'error');
                } finally {
                    showLoading(false);
                }
            }
        }
        
        function viewLetter(index) {
            const letter = state.letters[index];
            if (!letter) return;
            const fontClass = letter.instrument === 'typewriter' ? 'font-typewriter' : 'font-quill';
            elements.letterView.className = `letter-view modal-content w-full max-w-4xl h-[90vh] p-8 md:p-16 overflow-y-auto relative rounded-2xl shadow-2xl ${letter.paperType} ${fontClass}`;
            elements.letterViewerContent.innerHTML = letter.content.replace(/\n/g, '<br>');
            screens.viewer.classList.remove('hidden');
        }

        async function renderGallery() {
            await loadLetters();
            elements.galleryGrid.innerHTML = '';
            if (state.letters.length === 0) {
                elements.galleryGrid.innerHTML = `<div class="col-span-full text-center py-16"><div class="text-6xl mb-4 opacity-50">üíå</div><p class="text-xl text-gray-500 font-light">A galeria est√° vazia.</p><p class="text-gray-400 mt-2">Escreva uma carta para come√ßar a sua cole√ß√£o.</p></div>`;
                return;
            }
            state.letters.forEach((letter, index) => {
                const envelopeElement = document.createElement('div');
                envelopeElement.className = 'envelope-wrapper animate-fade-in';
                envelopeElement.style.animationDelay = `${index * 0.1}s`;
                envelopeElement.setAttribute('role', 'button');
                envelopeElement.setAttribute('tabindex', '0');
                envelopeElement.setAttribute('aria-label', `Ler carta ${index + 1}`);
                const fontClass = letter.instrument === 'typewriter' ? 'font-typewriter text-xs' : 'font-quill text-base';
                const preview = letter.content.substring(0, 250);
                envelopeElement.innerHTML = `
                    <div class="envelope envelope-back"></div>
                    <div class="letter-paper ${letter.paperType} ${fontClass}">${preview.replace(/\n/g, '<br>')}</div>
                    <div class="envelope envelope-front"></div>
                    <div class="envelope envelope-flap"></div>
                    <div class="delete-btn-gallery" role="button" aria-label="Excluir carta ${index + 1}" title="Excluir Carta">√ó</div>`;
                envelopeElement.addEventListener('click', () => viewLetter(index));
                envelopeElement.querySelector('.delete-btn-gallery').addEventListener('click', (event) => deleteLetter(letter.id, event));
                elements.galleryGrid.appendChild(envelopeElement);
            });
        }
        
        // --- Sistema de PDF ---
        function generatePDF() {
            if (!state.currentText.trim()) { showFeedback('Escreva algo antes de gerar o PDF!', 'error'); return; }
            showLoading(true);
            const fontClass = state.chosenInstrument === 'typewriter' ? 'font-typewriter' : 'font-quill';
            const element = document.createElement('div');
            element.className = `${state.chosenPaper} ${fontClass} p-16 text-2xl leading-loose`;
            element.style.width = '210mm'; element.style.minHeight = '297mm';
            element.innerHTML = state.currentText.replace(/\n/g, '<br>');
            const opt = { margin: 0, filename: `carta-${new Date().toISOString().split('T')[0]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save().then(() => { showLoading(false); showFeedback('PDF baixado com sucesso!', 'success'); }).catch((error) => { showLoading(false); console.error('Erro ao gerar PDF:', error); showFeedback('Erro ao gerar PDF', 'error'); });
        }

        // --- Sistema de Desafios ---
        const challenges = [ "Escreva uma carta para voc√™ mesmo daqui a 10 anos.", "Descreva um dia perfeito usando apenas os cinco sentidos.", "Conte a hist√≥ria de um objeto antigo que encontrou.", "Escreva sobre um lugar que existe apenas na sua mem√≥ria.", "Imagine uma conversa com algu√©m que voc√™ gostaria de conhecer.", "Descreva o som da chuva para algu√©m que nunca ouviu.", "Escreva sobre um momento em que o tempo parou.", "Conte a hist√≥ria de uma fotografia que n√£o existe.", "Escreva uma carta de agradecimento para um estranho.", "Descreva a cor azul para algu√©m que nasceu cego." ];
        function showChallenge() { const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)]; elements.challengeText.textContent = randomChallenge; screens.challenge.classList.remove('hidden'); }

        // --- Event Listeners ---
        function setupEventListeners() {
            elements.btnPublish.addEventListener('click', publishLetter);
            elements.btnPdf.addEventListener('click', generatePDF);
            elements.btnChallenge.addEventListener('click', showChallenge);
            elements.btnCloseChallenge.addEventListener('click', () => screens.challenge.classList.add('hidden'));
            document.addEventListener('keydown', (e) => { if ((e.key === 'Enter' || e.key === ' ') && e.target.getAttribute('role') === 'button') { e.preventDefault(); e.target.click(); } });
        }

        // --- Inicializa√ß√£o ---
        function initialize() {
            setupNavigation();
            setupSelections();
            setupWriting();
            setupEventListeners();
            console.log('Ateli√™ Epistolar inicializado!');
        }
        document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>
